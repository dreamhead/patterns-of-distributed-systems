# Quorum

**原文**

https://martinfowler.com/articles/patterns-of-distributed-systems/quorum.html

避免两组服务器做出独立的决定，每项决定都需要多数人同意。

11 August 2020

# 问题

在一个分布式系统中，每当服务器采取任何操作时，都需要确保在发生崩溃的情况下，操作的结果可以提供给客户端。这可以通过将结果复制到集群中的其他服务器来实现。但这就引出了一个问题：需要有多少其他服务器确认复制后，原服务器才能确信更新被完全确认。如果原始服务器等待的复制次数过多，那么它的响应速度就会很慢--降低可用性。但如果它没有足够的复制，那么更新可能会丢失---安全性失败。在整体系统性能和系统连续性之间取得平衡是至关重要的。

# 解决方案

当集群中的大多数节点都承认更新时，集群就同意它收到了更新。我们把这个数字称为法定人数。因此，如果我们有一个由五个节点组成的集群，我们需要的法定人数是三个。对于一个由n个节点组成的集群，法定人数是n/2+1）。

对法定人数的需求表示可以容忍多少次故障--这就是集群的规模减去法定人数。一个由五个节点组成的集群可以容忍其中的两个节点失败。一般来说，如果我们想容忍'f'次故障，我们需要一个`2n+1`的集群大小。

考虑以下两个需要法定人数的例子。

- **更新服务器群集中的数据:** [高水位标记](https://github.com/dreamhead/patterns-of-distributed-systems/blob/master/content/high-water-mark.md)用于确保只有保证数据在大多数服务器上可用才对客户端可见。
- **领导者选举:** 在领导者和追随者中，只有当一个领袖获得大多数服务器的投票时才会被选中。

## 集群中服务器数量

只有当大部分服务器都启动并运行时，集群才能发挥作用。在进行数据复制的系统中，有两点需要考虑:

- 写操作的吞吐量

    每次向集群写入数据时，都需要将数据复制到多台服务器上。每增加一台服务器都会增加一些开销来完成这个写入操作。数据写入的延迟与形成定额的服务器数量成正比。下面我们会看到，将集群中的服务器数量增加一倍，将使吞吐量降低到原来集群数值的一半。

- 需要容忍的故障数量

    容忍的服务器故障数量取决于集群的规模。但是，只是在现有的集群中增加一台服务器并不总是能提供更多的容错率：在一个三台服务器的集群中增加一台服务器并不能增加故障容忍度。

考虑到这两个因素，大多数实用的基于法定人数的系统的集群规模为三台或五台。一个五台服务器的集群可以容忍两台服务器的故障，并且可以容忍每秒几千个请求的数据写入吞吐量。

下面以服务器数量为例，根据可容忍的故障数和对吞吐量的近似影响来选择服务器的数量。吞吐量一栏显示了近似的相对吞吐量，以突出吞吐量如何随着服务器数量的增加而降低。这个数字会因系统而异。作为一个例子，读者可以参考[Raft论文](https://web.stanford.edu/~ouster/cgi-bin/papers/OngaroPhD.pdf)和[Zookeeper](https://www.usenix.org/legacy/event/atc10/tech/full_papers/Hunt.pdf)原始论文中公布的实际吞吐量数据。

|  Number of Servers|  Quorum  | Number Of Tolerated Failures | Representative Throughput  |
| ---- | ---- | ---- | ---- |
|   1  |  1   |  0   | 100  |
|   2  |  2   |  0   | 85   |
|   3  |  2   |  1   | 82   |
|   4  |  3   |  1   | 57   |
|   5  |  3   |  2   | 48   |
|   6  |  4   |  2   | 41   |
|   7  |  5   |  3   | 36   |

# 示例

- 所有的共识实现如[Zab](https://zookeeper.apache.org/doc/r3.4.13/zookeeperInternals.html#sc_atomicBroadcast)、[Raft](https://raft.github.io/)、[Paxos](https://en.wikipedia.org/wiki/Paxos_(computer_science))都是基于法定人数的。
- 即使在不使用共识的系统中，也会使用quorum来确保在故障或网络分区的情况下，至少有一台服务器可以获得最新的更新。例如，在像[Cassandra](http://cassandra.apache.org/)这样的数据库中，数据库更新可以被配置为只有在大多数服务器成功更新记录后才返回成功。